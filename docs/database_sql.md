-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.QuietVillage Usage (
  id integer NOT NULL DEFAULT nextval('"QuietVillage Usage_id_seq"'::regclass),
  user_name character varying NOT NULL,
  user_tech_id character varying NOT NULL,
  session_id character varying NOT NULL,
  beta_code_id integer,
  user_input text NOT NULL,
  ai_response text NOT NULL,
  interaction_number integer NOT NULL,
  execution_id character varying,
  thread_id character varying,
  scenario_name character varying DEFAULT 'TradeSphere_AI_Agent'::character varying,
  response_time_ms numeric,
  input_tokens integer,
  output_tokens integer,
  total_tokens integer,
  user_message_sent_at timestamp with time zone,
  ai_response_sent_at timestamp with time zone,
  created_at timestamp with time zone DEFAULT now(),
  message_type character varying DEFAULT 'chat'::character varying,
  success boolean DEFAULT true,
  error_message text,
  interaction_summary text,
  CONSTRAINT QuietVillage Usage_pkey PRIMARY KEY (id)
);
CREATE TABLE public.VC Usage (
  id integer NOT NULL DEFAULT nextval('"QuietVillage Usage_id_seq"'::regclass),
  user_name character varying NOT NULL,
  user_tech_id character varying NOT NULL,
  session_id character varying NOT NULL,
  beta_code_id integer,
  user_input text NOT NULL,
  ai_response text NOT NULL,
  interaction_number integer NOT NULL,
  scenario_name character varying DEFAULT 'TradeSphere_AI_Agent'::character varying,
  total_tokens integer,
  created_at timestamp with time zone DEFAULT now(),
  message_type character varying DEFAULT 'chat'::character varying,
  success boolean DEFAULT true,
  error_message text,
  interaction_summary text,
  customer_name character varying,
  customer_address text,
  customer_email character varying,
  customer_phone character varying,
  processing_time_ms numeric,
  ai_model character varying,
  prompt_tokens integer,
  completion_tokens integer,
  response_length integer,
  services_count integer,
  confidence_score numeric,
  gpt_splitting_time_ms numeric,
  parameter_collection_time_ms numeric,
  pricing_calculation_time_ms numeric,
  ai_generation_time_ms numeric,
  last_viewed_at timestamp with time zone,
  view_count integer DEFAULT 0,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT VC Usage_pkey PRIMARY KEY (id)
);
CREATE TABLE public.beta_codes (
  id integer NOT NULL DEFAULT nextval('beta_codes_id_seq'::regclass),
  code character varying NOT NULL UNIQUE,
  used boolean DEFAULT false,
  used_by_email character varying,
  used_by_user_id text,
  used_at timestamp without time zone,
  created_at timestamp without time zone DEFAULT now(),
  expires_at timestamp without time zone DEFAULT (now() + '30 days'::interval),
  CONSTRAINT beta_codes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.beta_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email character varying UNIQUE,
  full_name character varying,
  job_title character varying,
  tech_uuid character varying NOT NULL UNIQUE,
  beta_code_used character varying,
  is_active boolean DEFAULT true,
  created_at timestamp without time zone DEFAULT now(),
  updated_at timestamp without time zone DEFAULT now(),
  first_name character varying,
  beta_code_id integer,
  is_admin boolean DEFAULT false,
  user_icon character varying NOT NULL DEFAULT 'User'::character varying,
  CONSTRAINT beta_users_pkey PRIMARY KEY (id),
  CONSTRAINT fk_beta_code FOREIGN KEY (beta_code_used) REFERENCES public.beta_codes(code)
);
CREATE TABLE public.clients (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  name character varying NOT NULL,
  email character varying,
  phone character varying,
  address jsonb,
  contact_person character varying,
  notes text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  is_active boolean DEFAULT true,
  CONSTRAINT clients_pkey PRIMARY KEY (id),
  CONSTRAINT clients_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT clients_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.companies (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name text NOT NULL,
  email text,
  phone text,
  address text,
  settings jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  new_id text,
  slug character varying UNIQUE,
  geo_code character varying,
  profit_tier character varying,
  subscription_tier character varying DEFAULT 'basic'::character varying,
  is_active boolean DEFAULT true,
  CONSTRAINT companies_pkey PRIMARY KEY (id)
);
CREATE TABLE public.company_notes (
  id bigint NOT NULL,
  notes_content text DEFAULT ''::text,
  updated_by text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT company_notes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.customer_interactions (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_tech_id text NOT NULL,
  customer_name text NOT NULL,
  session_id text,
  interaction_type text NOT NULL CHECK (interaction_type = ANY (ARRAY['view'::text, 'edit'::text, 'load'::text])),
  viewed_at timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT customer_interactions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.demo_messages (
  id bigint NOT NULL DEFAULT nextval('demo_messages_id_seq'::regclass),
  session_id text NOT NULL,
  message_text text NOT NULL,
  sender text NOT NULL,
  tech_id text,
  created_at timestamp with time zone DEFAULT now(),
  message_source character varying DEFAULT 'make_com'::character varying,
  CONSTRAINT demo_messages_pkey PRIMARY KEY (id)
);
CREATE TABLE public.feedback (
  id bigint NOT NULL DEFAULT nextval('feedback_id_seq'::regclass),
  user_name text NOT NULL,
  feedback_text text NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT feedback_pkey PRIMARY KEY (id)
);
CREATE TABLE public.finalized_quotes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  quote_session_id uuid,
  technician_id uuid,
  company_id uuid NOT NULL,
  quote_number text NOT NULL UNIQUE,
  client_name text NOT NULL,
  client_phone text,
  client_email text,
  client_address text NOT NULL,
  property_type text NOT NULL CHECK (property_type = ANY (ARRAY['residential'::text, 'commercial'::text, 'industrial'::text])),
  service_type text NOT NULL CHECK (service_type = ANY (ARRAY['landscaping'::text, 'maintenance'::text, 'installation'::text, 'removal'::text, 'design'::text, 'irrigation'::text])),
  property_size text,
  urgency text DEFAULT 'standard'::text CHECK (urgency = ANY (ARRAY['standard'::text, 'rush_within_week'::text, 'urgent_within_48hrs'::text, 'emergency_same_day'::text])),
  access_difficulty text DEFAULT 'easy'::text CHECK (access_difficulty = ANY (ARRAY['easy_standard_access'::text, 'moderate_some_obstacles'::text, 'difficult_major_constraints'::text, 'extreme_specialized_equipment'::text])),
  timeline text,
  special_requirements text,
  job_description text,
  labor_hours_actual numeric NOT NULL,
  labor_rate numeric NOT NULL,
  labor_total numeric NOT NULL,
  materials_list jsonb NOT NULL DEFAULT '[]'::jsonb,
  materials_cost numeric NOT NULL DEFAULT 0,
  equipment_needed jsonb DEFAULT '[]'::jsonb,
  equipment_cost numeric DEFAULT 0,
  travel_time numeric DEFAULT 0,
  travel_cost numeric DEFAULT 0,
  overhead_percentage numeric DEFAULT 15,
  overhead_amount numeric NOT NULL,
  profit_margin numeric DEFAULT 20,
  profit_amount numeric NOT NULL,
  subtotal numeric NOT NULL,
  tax_percentage numeric DEFAULT 0,
  tax_amount numeric DEFAULT 0,
  total_quote_amount numeric NOT NULL,
  quote_accepted boolean,
  acceptance_date timestamp with time zone,
  rejection_reason text,
  actual_labor_hours numeric,
  actual_materials_cost numeric,
  actual_total_cost numeric,
  job_completed boolean DEFAULT false,
  job_completion_date timestamp with time zone,
  season text CHECK (season = ANY (ARRAY['spring'::text, 'summer'::text, 'fall'::text, 'winter'::text])),
  weather_conditions text,
  local_market_conditions text,
  competitor_pricing_intel text,
  quote_date date NOT NULL DEFAULT CURRENT_DATE,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT finalized_quotes_pkey PRIMARY KEY (id),
  CONSTRAINT finalized_quotes_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES public.users(id),
  CONSTRAINT finalized_quotes_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT finalized_quotes_quote_session_id_fkey FOREIGN KEY (quote_session_id) REFERENCES public.quote_sessions(id)
);
CREATE TABLE public.jobs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  client_id uuid NOT NULL,
  title character varying NOT NULL,
  description text,
  status character varying DEFAULT 'pending'::character varying,
  priority character varying DEFAULT 'medium'::character varying,
  start_date date,
  end_date date,
  estimated_hours numeric,
  actual_hours numeric DEFAULT 0,
  budget numeric,
  actual_cost numeric DEFAULT 0,
  location jsonb,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  assigned_to ARRAY,
  CONSTRAINT jobs_pkey PRIMARY KEY (id),
  CONSTRAINT jobs_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id),
  CONSTRAINT jobs_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT jobs_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id)
);
CREATE TABLE public.labor_entries (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  job_id uuid NOT NULL,
  user_id uuid NOT NULL,
  start_time timestamp with time zone NOT NULL,
  end_time timestamp with time zone,
  hours numeric,
  hourly_rate numeric,
  description text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT labor_entries_pkey PRIMARY KEY (id),
  CONSTRAINT labor_entries_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT labor_entries_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT labor_entries_job_id_fkey FOREIGN KEY (job_id) REFERENCES public.jobs(id)
);
CREATE TABLE public.materials (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  name character varying NOT NULL,
  description text,
  unit character varying,
  cost_per_unit numeric,
  current_stock integer DEFAULT 0,
  minimum_stock integer DEFAULT 0,
  supplier character varying,
  sku character varying,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT materials_pkey PRIMARY KEY (id),
  CONSTRAINT materials_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.pricing_catalog (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  company_id uuid NOT NULL,
  item_name text NOT NULL,
  item_category text NOT NULL,
  base_price numeric NOT NULL,
  unit text NOT NULL,
  labor_hours_required numeric DEFAULT 0,
  profit_margin_percentage numeric DEFAULT 20,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pricing_catalog_pkey PRIMARY KEY (id)
);
CREATE TABLE public.pricing_chat_sessions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  company_id uuid NOT NULL,
  user_id uuid,
  session_name text DEFAULT 'Pricing Chat'::text,
  conversation_history jsonb DEFAULT '{"messages": []}'::jsonb,
  last_message_at timestamp with time zone DEFAULT now(),
  session_status text DEFAULT 'active'::text CHECK (session_status = ANY (ARRAY['active'::text, 'completed'::text, 'archived'::text])),
  total_quotes_generated integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pricing_chat_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT pricing_chat_sessions_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT pricing_chat_sessions_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.pricing_formulas (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  company_id uuid NOT NULL,
  formula_name text NOT NULL,
  formula_category text NOT NULL,
  display_name text NOT NULL,
  description text,
  formula_expression text NOT NULL,
  default_variables jsonb NOT NULL DEFAULT '{}'::jsonb,
  required_variables ARRAY NOT NULL DEFAULT '{}'::text[],
  optional_variables jsonb DEFAULT '{}'::jsonb,
  trigger_keywords ARRAY NOT NULL DEFAULT '{}'::text[],
  usage_context ARRAY,
  min_quantity numeric DEFAULT 0,
  max_quantity numeric,
  unit_type text NOT NULL,
  expected_min_price numeric,
  expected_max_price numeric,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT pricing_formulas_pkey PRIMARY KEY (id),
  CONSTRAINT pricing_formulas_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.quote_materials (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  finalized_quote_id uuid,
  material_name text NOT NULL,
  material_category text,
  quantity numeric NOT NULL,
  unit text NOT NULL,
  unit_cost numeric NOT NULL,
  total_cost numeric NOT NULL,
  supplier text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT quote_materials_pkey PRIMARY KEY (id),
  CONSTRAINT quote_materials_finalized_quote_id_fkey FOREIGN KEY (finalized_quote_id) REFERENCES public.finalized_quotes(id)
);
CREATE TABLE public.quote_sessions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  technician_id uuid,
  company_id uuid,
  telegram_user_id text,
  status text DEFAULT 'quote_started'::text CHECK (status = ANY (ARRAY['quote_started'::text, 'quote_abandoned_before_end'::text, 'quote_not_accepted'::text, 'quote_completed'::text])),
  client_name text,
  client_phone text,
  client_email text,
  client_address text,
  property_type text CHECK (property_type = ANY (ARRAY['residential'::text, 'commercial'::text, 'industrial'::text])),
  service_type text CHECK (service_type = ANY (ARRAY['landscaping'::text, 'maintenance'::text, 'installation'::text, 'removal'::text, 'design'::text, 'irrigation'::text, 'hardscaping*'::text, 'tree_service*'::text])),
  property_size text,
  urgency text DEFAULT 'standard'::text CHECK (urgency = ANY (ARRAY['standard'::text, 'rush_within_week'::text, 'urgent_within_48hrs'::text, 'emergency_same_day'::text])),
  access_difficulty text DEFAULT 'easy_standard_access'::text CHECK (access_difficulty = ANY (ARRAY['easy_standard_access'::text, 'moderate_some_obstacles'::text, 'difficult_major_constraints'::text, 'extreme_specialized_equipment'::text])),
  timeline text DEFAULT 'flexible_schedule'::text CHECK (timeline = ANY (ARRAY['flexible_schedule'::text, 'within_one_week'::text, 'within_two_weeks'::text, 'within_month'::text, 'seasonal_specific'::text])),
  special_requirements text,
  labor_hours_estimated numeric DEFAULT 0,
  labor_rate numeric DEFAULT 0,
  materials_list jsonb DEFAULT '[]'::jsonb,
  materials_cost numeric DEFAULT 0,
  equipment_needed jsonb DEFAULT '[]'::jsonb,
  equipment_cost numeric DEFAULT 0,
  travel_time numeric DEFAULT 0,
  overhead_percentage numeric DEFAULT 15,
  profit_margin numeric DEFAULT 20,
  subtotal numeric DEFAULT 0,
  total_quote_amount numeric DEFAULT 0,
  conversation_history jsonb DEFAULT '[]'::jsonb,
  ai_suggestions_made jsonb DEFAULT '[]'::jsonb,
  ai_suggestions_accepted jsonb DEFAULT '[]'::jsonb,
  pricing_rationale text,
  competitive_analysis text,
  form_completion_percentage integer DEFAULT 0 CHECK (form_completion_percentage >= 0 AND form_completion_percentage <= 100),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  completed_at timestamp with time zone,
  weather_dependent boolean DEFAULT false,
  CONSTRAINT quote_sessions_pkey PRIMARY KEY (id),
  CONSTRAINT quote_sessions_technician_id_fkey FOREIGN KEY (technician_id) REFERENCES public.users(id),
  CONSTRAINT quote_sessions_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);
CREATE TABLE public.quotes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  company_id uuid NOT NULL,
  client_id uuid NOT NULL,
  quote_number character varying NOT NULL UNIQUE,
  title character varying NOT NULL,
  description text,
  items jsonb NOT NULL DEFAULT '[]'::jsonb,
  subtotal numeric,
  tax_amount numeric,
  total_amount numeric,
  status character varying DEFAULT 'draft'::character varying,
  valid_until date,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  created_by uuid,
  ai_session_id character varying,
  ai_metadata jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT quotes_pkey PRIMARY KEY (id),
  CONSTRAINT quotes_client_id_fkey FOREIGN KEY (client_id) REFERENCES public.clients(id),
  CONSTRAINT quotes_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT quotes_created_by_fkey FOREIGN KEY (created_by) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL,
  email text NOT NULL,
  full_name text,
  role text DEFAULT 'employee'::text,
  company_id uuid,
  phone text,
  is_active boolean DEFAULT true,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  auth_user_id uuid,
  first_name character varying,
  last_name character varying,
  last_login timestamp with time zone,
  permissions jsonb DEFAULT '{}'::jsonb,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT fk_users_company FOREIGN KEY (company_id) REFERENCES public.companies(id),
  CONSTRAINT users_company_id_fkey FOREIGN KEY (company_id) REFERENCES public.companies(id)
);